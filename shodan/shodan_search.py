#!/usr/bin/env python

import shodan
import sys
import time

def usage():
    print "%s <query string> <max attempts (optional, default = 5)>" % (sys.argv[0])

if len(sys.argv) < 2 or len(sys.argv) > 3:
    usage()
    sys.exit(0)

query_txt = sys.argv[1]
max_attempts = 5
if len(sys.argv) == 3:
    max_attempts = int(sys.argv[2]

api_key = "XXXXXXXXXXXXXXXXXXXXXXXXXXXXX" # Enter your SHODAN API KEY here
shodan_api_object = shodan.Shodan(api_key)
finished = False
i = 1;
while not finished:
    if (i > max_attempts):
        print "Attempted to connect " + str(max_attempts) + " times and could not.   EXITING"
        break
    print "Attempting try #" + str(i)
    i = i + 1
    try:
        result = shodan_api_object.search(query=query_txt, minify=True)
        for t1 in result['matches']:
            print t1['ip_str'] + " " + str(t1['port']) + "/" + t1['transport'] + " (" + t1['_shodan']['module'] + ")"
        finished = True
    except shodan.exception.APIError as e:
        if str(e) == "Unable to connect to Shodan":
            finished = False
            time.sleep(1)
        else:
            print "Unhandled error occured: " + e
            sys.exit(1)
