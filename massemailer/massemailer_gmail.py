#!/usr/bin/env python

import sys
import smtplib

def send_email_gmail(username, password, email_from, email_to, subject, body):
    # connect to remote mail server and forward message on
    server = smtplib.SMTP("smtp.gmail.com", 587)
    message = "From: %s\r\nTo: %s\r\nSubject: %s\r\n\r\n%s" % (email_from, email_to, subject, body)

    smtp_sendmail_return = ""
    try:
        server.ehlo()
        server.starttls()
        server.login(username,password)
        smtp_sendmail_return = server.sendmail(email_from, email_to, message)
    except Exception, e:
        print 'SMTP Exception:\n' + str( e) + '\n' + str( smtp_sendmail_return)
    finally:
        server.quit()

def loademails(filename):
    with open(filename, 'r') as f:
        return f.read().splitlines()

def loadbody(filename):
    with open(filename, 'r') as f:
        return f.read()

if __name__ == "__main__":
    def usage():
        print "%s <login name> <login password> <from emailaddress> <subject> <to emailaddress file> <email body file>" % (sys.argv[0])
    if (len(sys.argv) <> 7):
        usage()
        sys.exit(0)

    username = sys.argv[1]
    password = sys.argv[2]
    fromemail = sys.argv[3]
    subject = sys.argv[4]
    emailfile = sys.argv[5]
    bodyfile = sys.argv[6]

    body = loadbody(bodyfile)

    for toemail in loademails(emailfile):
        send_email_gmail(username, password, fromemail, toemail, subject, body)
